<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Repeating Audio Pages</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  #timer { font-size: 24px; color: red; margin-bottom: 20px; }
  
  /* CRITICAL CSS: Hide the video content initially */
  #content { display: none; } 
  
  #startButton {
    padding: 15px 30px;
    font-size: 20px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
  }

  /* CSS to hide native video controls */
  .video-hidden::-webkit-media-controls-enclosure {
    display: none !important;
  }
  .video-hidden::-moz-media-controls-enclosure {
    display: none !important;
  }
</style>
</head>
<body>
<h1>Listening Task</h1>
<div id="timer"></div>

<div id="startContainer">
  <button id="startButton" onclick="startTask()">Start Page 1</button>
</div>

<div id="content"></div>

<script>
let page = 1;
let totalPages = 3; // Set the total number of loops

// --- Video Template ---
const videoHTML = `
  <video 
    id="listeningVideo" 
    width="560" 
    height="315" 
    class="video-hidden" 
    onended="handleVideoEnd()" 
    playsinline
  >
    <source src="video.mp4" type="video/mp4"> 
    Your browser does not support the video tag.
  </video>
`;

// --- 1. START FUNCTION (Triggered by button) ---
function startTask() {
    const startContainer = document.getElementById('startContainer');
    const content = document.getElementById('content');

    // 1. Hide Button, Show Video Container
    startContainer.style.display = 'none';
    content.style.display = 'block';

    // 2. Insert the video (Fresh copy for a clean start)
    content.innerHTML = videoHTML;
    document.getElementById('timer').innerText = `Page ${page} playing...`;

    // 3. Play Logic
    const videoElement = document.getElementById('listeningVideo');
    videoElement.addEventListener('loadedmetadata', attemptPlayback);
    if (videoElement.readyState >= 1) attemptPlayback();
}

// --- 2. END FUNCTION (Triggered when video finishes) ---
function handleVideoEnd() {
    const startContainer = document.getElementById('startContainer');
    const content = document.getElementById('content');
    const button = document.getElementById('startButton');

    if (page < totalPages) {
        // --- THE RELIABLE RESET LOGIC ---
        page++; // Advance to the next page number

        // 1. Clear the old video and hide the content container
        content.innerHTML = "";
        content.style.display = 'none'; 

        // 2. Update button and timer text for the next page
        button.innerText = `Start Page ${page}`;
        document.getElementById('timer').innerText = `Page ${page - 1} finished. Click below for Page ${page}.`;

        // 3. Show the button container again
        startContainer.style.display = 'block';

    } else {
        // --- ALL DONE LOGIC (Final completion) ---
        content.innerHTML = "<h2>All " + totalPages + " Pages Complete. Thank you.</h2>";
        document.getElementById('timer').innerText = "";
        startContainer.style.display = 'none'; 
    }
}

// Helper function for reliable playback
function attemptPlayback() {
    const videoElement = document.getElementById('listeningVideo');
    if(videoElement) {
        videoElement.play().catch(e => console.error(e));
        videoElement.removeEventListener('loadedmetadata', attemptPlayback);
    }
}

// Initial Setup
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('timer').innerText = "Click 'Start' to begin Page 1.";
});
</script>
</body>
</html>
