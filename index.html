<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Repeating Audio Pages</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  #timer { font-size: 24px; color: red; margin-bottom: 20px; }
  
  /* The specific Audio Test warning style */
  #testWarning {
    background-color: #ffeded;
    color: #d9534f;
    padding: 15px;
    border: 1px solid #d9534f;
    margin-bottom: 20px;
    font-weight: bold;
    display: none; /* Hidden by default */
  }

  #instructionBox {
    margin: 20px auto;
    padding: 15px;
    width: 60%;
    border: 2px solid #333;
    background-color: #f9f9f9;
    font-weight: bold;
    display: none;
  }

  #videoWrapper {
    position: relative;
    display: inline-block;
    width: 560px;
    height: 315px;
    background-color: #000;
  }

  #pageOverlay {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 12px;
    border-radius: 4px;
    font-size: 18px;
    font-weight: bold;
    z-index: 10;
  }

  #content { display: none; } 
  
  #startButton {
    padding: 15px 30px;
    font-size: 20px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
  }

  .video-hidden::-webkit-media-controls-enclosure {
    display: none !important;
  }
  .video-hidden::-moz-media-controls-enclosure {
    display: none !important;
  }
</style>
</head>
<body>

<div id="testWarning">Audio Quality Control Test: If you cannot hear any sounds coming from your speakers please adjust your audio settings and refresh the page.</div>

<h1>Listening Task</h1>

<div id="instructionBox"></div>
<div id="timer"></div>

<div id="startContainer">
  <button id="startButton" onclick="startTask()">Start Audio Test</button>
</div>

<div id="content">
    <div id="videoWrapper">
        <div id="pageOverlay"></div>
        <div id="videoPlaceholder"></div>
    </div>
</div>

<script>
const videoFiles = [
  "Plane Clip 1.mp4", "Plane Clip 2.mp4", "Plane Clip 3.mp4", "Plane Clip 4.mp4", "Plane Clip 5.mp4",
  "Train Clip 1.mp4", "Train Clip 2.mp4", "Train Clip 3.mp4", "Train Clip 4.mp4", "Train Clip 5.mp4",
  "Dance Clip 1.mp4", "Dance Clip 2.mp4", "Dance Clip 3.mp4", "Dance Clip 4.mp4", "Dance Clip 5.mp4"
];

let videoIndex = 0;    
let repeatCount = 1;   
const totalRepeats = 3;
let isAudioTest = true; // State to track if we are in the test phase

function updateInstructionText() {
    const instructionBox = document.getElementById('instructionBox');
    
    // If it's the audio test, we don't need the bottom instruction box text
    if (isAudioTest) {
        instructionBox.style.display = "none";
        return;
    }

    const currentFile = videoFiles[videoIndex];
    if (!currentFile) {
        instructionBox.style.display = "none";
        instructionBox.innerText = "";
        return;
    }

    instructionBox.style.display = "block";

    if (currentFile.startsWith("Plane")) {
        instructionBox.innerText = "In the next five clips, we are discussing plane travel";
    } else if (currentFile.startsWith("Train")) {
        instructionBox.innerText = "In the next five clips, we are discussing train travel";
    } else if (currentFile.startsWith("Dance")) {
        instructionBox.innerText = "In the next five clips, we are discussing our wheelchair dance club";
    } else {
        instructionBox.innerText = "";
        instructionBox.style.display = "none";
    }
}

function handleVideoEnd() {
    const startContainer = document.getElementById('startContainer');
    const content = document.getElementById('content');
    const button = document.getElementById('startButton');
    const instructionBox = document.getElementById('instructionBox');
    const testWarning = document.getElementById('testWarning');

    instructionBox.innerText = "";
    instructionBox.style.display = "none";

    // Handle end of Audio Test
    if (isAudioTest) {
        isAudioTest = false; // Move to main task
        testWarning.style.display = "none"; // Remove warning
        
        document.getElementById('videoPlaceholder').innerHTML = "";
        content.style.display = 'none'; 

        const nextFile = videoFiles[0].replace('.mp4', '');
        button.innerText = `Start ${nextFile} (Attempt 1)`;
        document.getElementById('timer').innerText = "Audio test complete. Click below to begin the task.";
        startContainer.style.display = 'block';
        return;
    }

    // Standard repeat logic
    if (repeatCount < totalRepeats) {
        repeatCount++;
    } else {
        videoIndex++;
        repeatCount = 1;
    }

    if (videoIndex < videoFiles.length) {
        document.getElementById('videoPlaceholder').innerHTML = "";
        content.style.display = 'none'; 

        const nextFile = videoFiles[videoIndex];
        const nextCleanName = nextFile.replace('.mp4', '');
        
        button.innerText = `Start ${nextCleanName} (Attempt ${repeatCount})`;
        document.getElementById('timer').innerText = `Finished previous play. Next: ${nextCleanName} (Repeat ${repeatCount}/3)`;

        startContainer.style.display = 'block';
    } else {
        content.innerHTML = "<h2>All 15 videos and their repetitions are complete.</h2>";
        document.getElementById('timer').innerText = "";
        startContainer.style.display = 'none'; 
    }
}

function getVideoHTML(videoSrc) {
  return `
    <video 
      id="listeningVideo" 
      width="560" 
      height="315" 
      class="video-hidden" 
      onended="handleVideoEnd()" 
      playsinline
    >
      <source src="${videoSrc}" type="video/mp4"> 
      Your browser does not support the video tag.
    </video>
  `;
}

function startTask() {
    const startContainer = document.getElementById('startContainer');
    const content = document.getElementById('content');
    const overlay = document.getElementById('pageOverlay');
    const testWarning = document.getElementById('testWarning');

    startContainer.style.display = 'none';
    content.style.display = 'block';

    if (isAudioTest) {
        // Play TestAudio.mp4 logic
        testWarning.style.display = "block";
        overlay.innerText = "Test Audio";
        document.getElementById('videoPlaceholder').innerHTML = getVideoHTML("TestAudio.mp4");
        document.getElementById('timer').innerText = "Playing Audio Test...";
    } else {
        // Regular video logic
        const currentFile = videoFiles[videoIndex];
        const cleanName = currentFile.replace('.mp4', '');
        overlay.innerText = "Video " + (videoIndex + 1);
        document.getElementById('videoPlaceholder').innerHTML = getVideoHTML(currentFile);
        document.getElementById('timer').innerText = `Playing ${cleanName} (Attempt ${repeatCount} of ${totalRepeats})`;
    }

    updateInstructionText();

    const videoElement = document.getElementById('listeningVideo');
    videoElement.addEventListener('loadedmetadata', attemptPlayback);
    if (videoElement.readyState >= 1) attemptPlayback();
}

function attemptPlayback() {
    const videoElement = document.getElementById('listeningVideo');
    if(videoElement) {
        videoElement.play().catch(e => console.error("Playback error:", e));
        videoElement.removeEventListener('loadedmetadata', attemptPlayback);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('timer').innerText = "Click 'Start Audio Test' to begin.";
});
</script>
</body>
</html>
